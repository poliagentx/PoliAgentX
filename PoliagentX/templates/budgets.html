{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}

<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
  <div class="mx-auto">
    
     <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-[#cb8700] mb-4">Budget</h1>
      <p class="text-gray-700 mb-4 leading-relaxed">
        If you have data on how the government spends across different development categories, you can upload it here. If you do not have disaggregated expenditure data, you can simply declare a total budget to be used by the model. The more disaggregate the data are, the more nuanced inferences you will be able to make.
      </p>
    </div>
    <!-- Status Messages -->
     <div id="status-messages" class="space-y-3 mb-6">
      <!-- Django messages for non-AJAX requests -->
      {% if messages %}
        {% for message in messages %}
          <div class="flex items-start p-4 rounded-lg border 
                      {% if message.tags == 'success' %}bg-green-50 text-green-800 border-green-200{% else %}bg-red-50 text-red-800 border-red-200{% endif %}">
            {% if message.tags == 'success' %}
              <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            {% else %}
              <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
            {% endif %}
            <div>
              <p class="font-medium">{% if message.tags == 'success' %}Success{% else %}Error{% endif %}</p>
              <p class="text-sm mt-1">{{ message }}</p>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Method Selection Tabs -->
    <div class="mb-8">
      <div class="flex bg-gray-100 rounded-lg p-1">
        <button id="upload-tab" class="flex-1 py-3 px-4 text-sm font-medium rounded-md transition-all duration-200 flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          Upload Detailed Data
        </button>
        <button id="manual-tab" class="flex-1 py-3 px-4 text-sm font-medium rounded-md transition-all duration-200 flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Manual Entry
        </button>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="bg-gradient-to-r from-[#0b0b0b]/5 to-[#0b0b0b]/8 backdrop-blur-xl border border-white/20 text-[#0b0b0b] shadow-[0_4px_20px_rgba(0,0,0,0.4)] rounded-xl p-8">

      
      <!-- File Upload Section -->
      <div id="upload-section" class="transition-all duration-300">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-[#cb8700] mb-2">Upload Budget Data</h2>
            <p class="text-gray-600">Upload detailed expenditure data by SDG categories for more nuanced analysis.</p>
          </div>
          <form action="{% url 'download_budget_template' %}" method="get">
            <button type="submit"
              class="group inline-flex items-center gap-2 mt-4 px-6 py-2
                    font-semibold tracking-wide
                    bg-gradient-to-r from-[#0b0b0b]/20 to-[#0b0b0b]/10
                    backdrop-blur-xl border border-white/20
                    text-[#0b0b0b] shadow-[0_4px_20px_rgba(0,0,0,0.4)]
                    hover:shadow-[0_0_20px_rgba(0,255,200,0.6)]
                    transition-all duration-500 ease-in-out">
              <!-- Download icon -->
              <svg class="w-5 h-5 shrink-0 transition-transform duration-300 group-hover:translate-y-0.5"
                  viewBox="0 0 24 24" fill="none" aria-hidden="true"
                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5"/>
                <path d="M7.5 10.5 12 15l4.5-4.5"/>
                <path d="M12 15V3"/>
              </svg>
              <span>Template</span>
            </button>
          </form>
        </div>

        <!-- File Upload Zone -->
        <div class="mb-8">
          <form action="{% url 'budgets_page' %}" method="post" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}
            {{ upload_form.media }}

            <!-- Progress Bar -->
            <div id="upload-progress" class="hidden mb-6">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Processing file...</span>
                <span id="progress-text" class="text-sm text-gray-500">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-[#cb8700] h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>

            <!-- Drag & Drop Zone -->
            <div id="drop-zone" class="border-2 border-dashed border-[#cb8700]/40 rounded-lg p-12 text-center bg-white/50 transition-all duration-300 hover:border-[#cb8700] hover:bg-white/70 cursor-pointer">
              <div class="space-y-4">
                <div id="upload-icon" class="mx-auto w-16 h-16 text-[#cb8700]">
                  <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
                  </svg>
                </div>
                
                <div>
                  <p id="upload-text" class="text-lg font-medium text-gray-700">Drop your indicators file here</p>
                <p class="text-sm text-gray-500 mt-1">or click to browse</p>
                <p class="text-xs text-gray-400 mt-2">Supports .xlsx, .xls files up to 10MB</p>
                </div>
              </div>
            </div>

            <!-- Hidden file input -->
            <input type="file" name="government_expenditure" id="file-input" accept=".xlsx,.xls," class="hidden">
          </form>
        </div>

        <!-- Data Requirements -->
        <div class="bg-white/30 border border-[#cb8700]/20 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Requirements:</h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start">
              <span class="w-1.5 h-1.5 bg-[#cb8700] rounded-full mt-2 mr-3 flex-shrink-0"></span>
              Include SDG categories and corresponding budget amounts
            </li>
            <li class="flex items-start">
              <span class="w-1.5 h-1.5 bg-[#cb8700] rounded-full mt-2 mr-3 flex-shrink-0"></span>
              Years must align with indicator data timeframe
            </li>
            <li class="flex items-start">
              <span class="w-1.5 h-1.5 bg-[#cb8700] rounded-full mt-2 mr-3 flex-shrink-0"></span>
              Currency amounts in local Currency 
            </li>
            <li class="flex items-start">
              <span class="w-1.5 h-1.5 bg-[#cb8700] rounded-full mt-2 mr-3 flex-shrink-0"></span>
              Inflation adjustments will be applied automatically
            </li>
          </ul>
        </div>
      </div>

      <!-- Manual Budget Entry Section -->
      <div id="manual-section" class="hidden transition-all duration-300">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-[#cb8700] mb-2">Manual Budget Entry</h2>
          <p class="text-gray-600">Enter a simple total budget amount. The system will distribute it across SDG categories automatically.</p>
        </div>
        
        <form action="{% url 'budgets_page' %}" method="post" class="space-y-6" enctype="multipart/form-data" id="budget-form">
          {% csrf_token %}
          {{ budget_form.media }}

          <div class="grid md:grid-cols-2 gap-6">
            <div class="form-group">
              <label for="{{ budget_form.budget.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Total Budget (USD millions)</label>
              <div class="relative">
                {{ budget_form.budget|as_crispy_field }}
              </div>
              {% if budget_form.budget.errors %}
                <p class="text-red-600 text-xs mt-1">{{ budget_form.budget.errors }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ budget_form.inflation_rate.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Annual Inflation Rate (%)</label>
              <div class="relative">
                {{ budget_form.inflation_rate|as_crispy_field }}
              </div>
              {% if budget_form.inflation_rate.errors %}
                <p class="text-red-600 text-xs mt-1">{{ budget_form.inflation_rate.errors }}</p>
              {% endif %}
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-blue-400 mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              <div class="text-sm text-blue-800">
                <p class="font-medium mb-1">How it works:</p>
                <p>The system will automatically distribute your total budget across SDG categories based on typical government spending patterns and your country's development priorities.</p>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- OR Divider (shown when switching is possible) -->
      <div id="method-divider" class="hidden my-8">
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">OR</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="mt-8 flex justify-between items-center">
     
      <div class="flex items-center space-x-4 ml-auto">
        <div id="next-disabled" class="{% if messages %}hidden{% endif %} flex items-center space-x-3">
          <button disabled class="inline-flex items-center px-6 py-3 bg-gray-400 text-white rounded-lg cursor-not-allowed font-semibold">
            NEXT →
          </button>
        </div>

        <div id="next-button-container" class="{% if not messages %}hidden{% endif %}">
          <a href="{% url 'upload_network' %}" 
             class="inline-flex items-center px-6 py-2 font-semibold tracking-wide bg-gradient-to-r from-[#0b0b0b]/20 to-[#0b0b0b]/10 backdrop-blur-xl border border-white/20 text-[#0b0b0b] shadow-[0_4px_20px_rgba(0,0,0,0.4)] hover:shadow-[0_0_20px_rgba(0,255,200,0.6)] transition-all duration-500 ease-in-out">
            NEXT →
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'Js/Button.js' %}"></script>

<!-- Fallback for non-JS users - show Django messages if JavaScript is disabled -->
<noscript>
  {% if messages %}
    {% for message in messages %}
      <div class="mt-4 p-3 rounded text-sm
                  {% if message.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
</noscript>

{% endblock %}