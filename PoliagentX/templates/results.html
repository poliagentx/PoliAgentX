{% extends "base.html" %}
{% load static %}

{% block title %}Simulation Results{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <h2 class="text-2xl font-bold mb-6 text-center">Simulation Results</h2>

    <!-- Number of simulations -->
    <div class="bg-white shadow-md rounded-xl p-6 mb-6">
        <label class="block mb-2 font-semibold">Number of Simulations:</label>
        <input type="text" value="{{ num_simulations }}" 
               class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
    </div>

    <!-- Indicator selection + Compare -->
    <div class="bg-white shadow-md rounded-xl p-6 mb-6 flex flex-col md:flex-row gap-6 items-center justify-between">
        <div class="w-full md:w-2/3">
            <label class="block mb-2 font-semibold">Select Indicator:</label>
            <select id="indicatorSelect" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                {% for indicator in indicators %}
                    <option value="{{ indicator }}">{{ indicator }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="compareBtn" 
                class="px-6 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow hover:opacity-90 transition">
            Compare Indicators
        </button>
    </div>

    <!-- Plots -->
    <div id="plots-container" class="grid gap-6"></div>

    <!-- Simulation Table -->
    <div class="bg-white shadow-md rounded-xl p-6 mt-8">
        <h3 class="text-xl font-semibold mb-4">Simulation Table</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-lg overflow-hidden">
                <thead class="bg-gray-100 text-gray-700">
                    <tr id="table-head"></tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Compare Indicators Modal -->
<div id="compareModal" class="fixed inset-0 hidden items-center justify-center z-50 backdrop-blur-md bg-black/40">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-96">
        <h4 class="text-lg font-semibold mb-4">Compare Indicators</h4>
        <form id="compareForm" class="space-y-3 max-h-64 overflow-y-auto">
            {% for row in table_rows %}
                <label class="flex items-center space-x-2 text-sm text-gray-700">
                    <input type="checkbox" name="indicators" value="{{ row.indicator_label }}"
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <span class="w-3 h-3 rounded-full bg-[{{ row.color }}]"></span>
                    <span>{{ row.indicator_label }}</span>
                </label>
            {% endfor %}
        </form>
        <div class="mt-6 flex justify-end gap-3">
            <button id="closeModal" 
                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition">
                Cancel
            </button>
            <button id="applyCompare" 
                    class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">
                Apply
            </button>
        </div>
    </div>
</div>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
const indicatorData = {{ indicator_data|safe }};
const allIndicators = Object.keys(indicatorData);

// --- Render plots ---
function renderPlots(indicators) {
    const container = document.getElementById("plots-container");
    container.innerHTML = "";

    indicators.forEach(ind => {
        const { x, y, goal, row } = indicatorData[ind];

        const trace = {
            x: x, y: y, mode: "lines+markers",
            name: row.indicator_label,
            line: { color: row.color },
            marker: { size: 6 }
        };

        const goalTrace = {
            x: x, y: goal, mode: "lines",
            name: `${row.indicator_label} Goal`,
            line: { dash: "dash", color: "gray" }
        };

        const layout = {
            title: row.indicator_label,
            margin: { t: 40, l: 50, r: 20, b: 40 },
            xaxis: { title: "Time" },
            yaxis: { title: "Value" },
            legend: { orientation: "h" }
        };

        const div = document.createElement("div");
        div.className = "bg-white shadow-md rounded-lg p-4 w-full h-[400px]";
        container.appendChild(div);

        Plotly.newPlot(div, [trace, goalTrace], layout, { responsive: true });
    });
}

// --- Render table ---
function renderTable(indicators) {
    const head = document.getElementById("table-head");
    const body = document.getElementById("table-body");
    head.innerHTML = "";
    body.innerHTML = "";

    if (indicators.length === 0) return;

    const firstInd = indicatorData[indicators[0]];
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = `<th class="px-4 py-2">Indicator</th>`;
    firstInd.x.forEach(t => {
        headerRow.innerHTML += `<th class="px-4 py-2">${t}</th>`;
    });
    head.appendChild(headerRow);

    indicators.forEach(ind => {
        const { y, row } = indicatorData[ind];
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `<td class="px-4 py-2 font-medium">${row.indicator_label}</td>`;
        y.forEach(val => {
            tr.innerHTML += `<td class="px-4 py-2">${val.toFixed(2)}</td>`;
        });
        body.appendChild(tr);
    });
}

// --- Initial render ---
renderPlots(allIndicators);
renderTable(allIndicators);

// --- Modal logic ---
const modal = document.getElementById("compareModal");
document.getElementById("compareBtn").addEventListener("click", () => {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
});
document.getElementById("closeModal").addEventListener("click", () => {
    modal.classList.remove("flex");
    modal.classList.add("hidden");
});
document.getElementById("applyCompare").addEventListener("click", () => {
    const selected = Array.from(document.querySelectorAll("#compareForm input:checked"))
                          .map(cb => cb.value);
    renderPlots(selected);
    renderTable(selected);
    modal.classList.remove("flex");
    modal.classList.add("hidden");
});
</script>
{% endblock %}
