{% extends "base.html" %}
{% load static %}

{% block title %}Simulation Results{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4 text-center">Simulation Results</h2>

    {% if error %}
        <div class="alert alert-warning">{{ error }}</div>
    {% else %}
        <!-- Simulation Form Card -->
        <div class="card shadow-sm p-3 mb-4">
            <form method="POST" action="{% url 'results_view' %}" class="row g-2 align-items-center">
                {% csrf_token %}
                <div class="col-md-4">
                    <label for="num_simulations" class="form-label fw-bold">Number of Simulations:</label>
                    <input type="number" name="num_simulations" id="num_simulations" class="form-control" value="50" min="1" max="1000" required>
                </div>
                <div class="col-md-2 mt-4">
                    <button type="submit" class="btn btn-primary w-100">Run Simulations</button>
                </div>
            </form>
        </div>

        <!-- Controls Card -->
        <div class="card shadow-sm p-3 mb-4 d-flex flex-wrap align-items-center gap-3">
            <div class="flex-grow-1">
                <label for="indicator-select" class="form-label fw-bold">Select Indicator:</label>
                <select id="indicator-select" class="form-select">
                    <option value="all" selected>All Indicators Combined</option>
                    {% for row in df_output_list %}
                        <option value="{{ row.indicator_label }}">{{ row.indicator_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#compareModal">Compare Indicators</button>
            </div>
        </div>

        <!-- Plots Container -->
        <div class="row" id="plots-container"></div>

        <!-- Table Container Card -->
        <div class="card shadow-sm p-3 mt-4">
            <h4>Simulation Table</h4>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-bordered" id="simulation-table">
                    <thead id="table-head"></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    {% endif %}
</div>

<!-- Compare Modal -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="compareModalLabel">Select Indicators to Compare</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="compare-form">
            {% for row in df_output_list %}
            <div class="form-check">
                <input class="form-check-input compare-checkbox" type="checkbox" value="{{ row.indicator_label }}" id="compare-{{ row.indicator_label }}">
                <label class="form-check-label" for="compare-{{ row.indicator_label }}">
                    {{ row.indicator_label }}
                </label>
            </div>
            {% endfor %}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="compare-submit" class="btn btn-primary">Compare</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- Bootstrap JS for modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rawData = JSON.parse("{{ df_output_json|escapejs }}");
    const container = document.getElementById("plots-container");

    // Prepare structured data
    const indicatorData = {};
    rawData.forEach(row => {
        const timeKeys = Object.keys(row)
            .filter(k => /^\d+$/.test(k))
            .sort((a, b) => parseInt(a) - parseInt(b));
        indicatorData[row.indicator_label] = {
            row: row,
            x: timeKeys.map(k => parseInt(k)),
            y: timeKeys.map(k => row[k]),
            goal: Array(timeKeys.length).fill(row.goal)
        };
    });

    const allIndicators = Object.keys(indicatorData);
    const selectEl = document.getElementById('indicator-select');

    // Render plots
    function renderPlots(selectedIndicators) {
        container.innerHTML = '';
        if(selectedIndicators.length === allIndicators.length) {
            const combinedX = indicatorData[allIndicators[0]].x;
            const combinedY = combinedX.map((_, t) => allIndicators.reduce((sum, label) => sum + indicatorData[label].y[t], 0));
            const combinedGoals = combinedX.map((_, t) => allIndicators.reduce((sum, label) => sum + indicatorData[label].goal[t], 0));

            const col = document.createElement('div');
            col.className = 'col-12 mb-4';
            const card = document.createElement('div');
            card.className = 'card shadow-sm p-3';
            const plotDiv = document.createElement('div');
            plotDiv.id = `plot-all`;
            plotDiv.style.height = '500px';
            card.appendChild(plotDiv);
            col.appendChild(card);
            container.appendChild(col);

            Plotly.newPlot(plotDiv, [
                {x: combinedX, y: combinedY, mode: 'lines+markers', name: 'Combined Indicators', line: { color: '#1f77b4', width: 3 }},
                {x: combinedX, y: combinedGoals, mode: 'lines', name: 'Combined Goals', line: { color: '#000', width: 2, dash: 'dash' }}
            ], {title: 'All Indicators Combined', xaxis:{title:'Time'}, yaxis:{title:'Level'}, legend:{orientation:'h',y:-0.2}}, {responsive:true});
        } else {
            selectedIndicators.forEach(label => {
                const dataObj = indicatorData[label];
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-4';
                const card = document.createElement('div');
                card.className = 'card shadow-sm p-3';
                const badge = document.createElement('span');
                badge.className = 'badge mb-2';
                badge.style.backgroundColor = dataObj.row.color;
                badge.textContent = 'SDG ' + dataObj.row.sdg;
                card.appendChild(badge);

                const plotDiv = document.createElement('div');
                plotDiv.id = `plot-${label.replace(/[^a-zA-Z0-9-_]/g,'')}`;
                plotDiv.style.height = '400px';
                card.appendChild(plotDiv);
                col.appendChild(card);
                container.appendChild(col);

                Plotly.newPlot(plotDiv, [
                    {x: dataObj.x, y: dataObj.y, mode:'lines+markers', name: label, line:{color:dataObj.row.color,width:3}},
                    {x: dataObj.x, y: dataObj.goal, mode:'lines', name:'Goal', line:{color:'#000', width:2,dash:'dash'}}
                ], {title:`Indicator: ${label}`, xaxis:{title:'Time'}, yaxis:{title:'Level'}, legend:{orientation:'h',y:-0.2}}, {responsive:true});
            });
        }
    }

    // Render table with SDG color-coding and tooltips
    function renderTable(selectedIndicators) {
        const thead = document.getElementById('table-head');
        const tbody = document.getElementById('table-body');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if(selectedIndicators.length === allIndicators.length) {
            const combinedX = indicatorData[allIndicators[0]].x;
            const headerRow = ['Time', ...allIndicators];
            thead.innerHTML = `<tr>${headerRow.map(h => `<th>${h}</th>`).join('')}</tr>`;

            combinedX.forEach((t, idx) => {
                const row = [t, ...allIndicators.map(l => indicatorData[l].y[idx])];
                tbody.innerHTML += `<tr>${row.map((v, colIdx) => {
                    if(colIdx===0) return `<td>${v}</td>`;
                    const label = allIndicators[colIdx-1];
                    const color = indicatorData[label].row.color;
                    const sdg = indicatorData[label].row.sdg;
                    return `<td style="background-color:${color};color:white;" title="SDG ${sdg}: ${v.toFixed(4)}">${v.toFixed(4)}</td>`;
                }).join('')}</tr>`;
            });
        } else if(selectedIndicators.length>1) {
            const firstX = indicatorData[selectedIndicators[0]].x;
            const headerRow = ['Time'];
            selectedIndicators.forEach(label => headerRow.push(`${label} Value`, `${label} Goal`));
            thead.innerHTML = `<tr>${headerRow.map(h=>`<th>${h}</th>`).join('')}</tr>`;

            firstX.forEach((t, idx) => {
                const row = [t];
                selectedIndicators.forEach(label => {
                    const dataObj = indicatorData[label];
                    row.push({value:dataObj.y[idx], color:dataObj.row.color, sdg:dataObj.row.sdg}, dataObj.goal[idx]);
                });
                tbody.innerHTML += `<tr>${row.map((cell, colIdx)=>{
                    if(colIdx===0) return `<td>${cell}</td>`;
                    if(typeof cell==='object') return `<td style="background-color:${cell.color};color:white;" title="SDG ${cell.sdg}: ${cell.value.toFixed(4)}">${cell.value.toFixed(4)}</td>`;
                    return `<td title="Goal: ${cell.toFixed(4)}">${cell.toFixed(4)}</td>`;
                }).join('')}</tr>`;
            });
        } else {
            const label = selectedIndicators[0];
            const dataObj = indicatorData[label];
            thead.innerHTML = `<tr><th>Time</th><th>Value</th><th>Goal</th></tr>`;
            dataObj.x.forEach((t, idx) => {
                const value = dataObj.y[idx];
                const goal = dataObj.goal[idx];
                const color = dataObj.row.color;
                const sdg = dataObj.row.sdg;
                tbody.innerHTML += `<tr>
                    <td>${t}</td>
                    <td style="background-color:${color};color:white;" title="SDG ${sdg}: ${value.toFixed(4)}">${value.toFixed(4)}</td>
                    <td title="Goal: ${goal.toFixed(4)}">${goal.toFixed(4)}</td>
                </tr>`;
            });
        }
    }

    // Initial render
    renderPlots(allIndicators);
    renderTable(allIndicators);

    // Dropdown change
    selectEl.addEventListener('change', () => {
        if(selectEl.value==='all'){
            renderPlots(allIndicators);
            renderTable(allIndicators);
        } else {
            renderPlots([selectEl.value]);
            renderTable([selectEl.value]);
        }
    });

    // Compare Modal Submit
    document.getElementById('compare-submit').addEventListener('click', () => {
        const checked = Array.from(document.querySelectorAll('.compare-checkbox:checked')).map(c=>c.value);
        if(checked.length>0){
            renderPlots(checked);
            renderTable(checked);
            const modal = bootstrap.Modal.getInstance(document.getElementById('compareModal'));
            modal.hide();
        }
    });
});
</script>

<style>
.card {border-radius: 10px;}
.badge {color:#fff;font-weight:bold;padding:5px 10px;font-size:0.9rem;display:inline-block;margin-bottom:5px;}
</style>
{% endblock %}
