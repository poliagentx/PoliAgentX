{% extends "base.html" %}
{% load static %}

{% block title %}Simulation Results{% endblock %}

{% include "result-header.html" %}  {# includes shared head and CSS #}

{% block content %}
<h2>Simulation Results</h2>

<div class="plots-container">
    {% for plot in plots_html %}
    <div class="plot-wrapper">
        {{ plot|safe }}
        {% if plot.layout.frames|length > 0 %}
        <div class="plot-buttons">
            <button class="play-btn">Play</button>
            <button class="pause-btn">Pause</button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
const figFrames = [];

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.plot-wrapper').forEach(wrapper => {
        const figDiv = wrapper.querySelector('.js-plotly-plot');
        if (!figDiv) return;

        const frames = figDiv._fullLayout?.frames || [];
        if (frames.length === 0) return;

        figFrames.push({
            fig: figDiv,
            frames: frames,
            max: frames.length,
            current: 0,
            intervalId: null
        });
    });

    document.body.addEventListener('click', function (e) {
        if (e.target.matches('.play-btn')) {
            const wrapper = e.target.closest('.plot-wrapper');
            const idx = [...document.querySelectorAll('.plot-wrapper')].indexOf(wrapper);
            const figData = figFrames[idx];
            if (!figData) return;

            clearInterval(figData.intervalId);
            figData.intervalId = setInterval(() => {
                figData.current = (figData.current + 1) % figData.max;
                const frameName = figData.frames[figData.current].name;
                Plotly.animate(figData.fig, [frameName], {
                    frame: { duration: 200, redraw: true },
                    transition: { duration: 0 }
                });
            }, 200);
        }

        if (e.target.matches('.pause-btn')) {
            const wrapper = e.target.closest('.plot-wrapper');
            const idx = [...document.querySelectorAll('.plot-wrapper')].indexOf(wrapper);
            const figData = figFrames[idx];
            if (!figData) return;
            clearInterval(figData.intervalId);
        }
    });
});
</script>
{% endblock %}
