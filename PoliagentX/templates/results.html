{% extends "base.html" %}
{% load static %}

{% block title %}Simulation Results{% endblock %}

{% block content %}

<div class="container mx-auto px-4 my-4">
    
    {% if error %}
        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative" role="alert">
            {{ error }}
        </div>
    {% else %}
     
        <!-- Tab Navigation -->
        <div class="mb-6">
            <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg" aria-label="Tabs">
                <button 
                    id="tab-evolution" 
                    class="tab-button active flex-1 py-3 px-6 text-sm font-medium rounded-md focus:outline-none transition-all duration-300 ease-in-out"
                    onclick="switchTab('evolution')">
                    Evolution Charts
                </button>
                <button 
                    id="tab-impact" 
                    class="tab-button flex-1 py-3 px-6 text-sm font-medium rounded-md focus:outline-none transition-all duration-300 ease-in-out"
                    onclick="switchTab('impact')">
                    Impact Charts
                </button>
                <button 
                    id="tab-priority" 
                    class="tab-button flex-1 py-3 px-6 text-sm font-medium rounded-md focus:outline-none transition-all duration-300 ease-in-out"
                    onclick="switchTab('priority')">
                    Priority Rankings
                </button>
                <button 
                    id="tab-scenarios" 
                    class="tab-button flex-1 py-3 px-6 text-sm font-medium rounded-md focus:outline-none transition-all duration-300 ease-in-out"
                    onclick="switchTab('scenarios')">
                    Scenarios
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="content-evolution" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="evolution-plots-container"></div>
                    <!-- Excel Download Section -->
        <div class="bg-white shadow-lg rounded-xl p-6 mt-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h4 class="text-xl font-semibold text-gray-800 mb-2">Download Simulation Data</h4>
                    <p class="text-gray-600 text-sm">Export the complete simulation results</p>
                </div>
                
                <button 
                    type="button" 
                    id="download-excel-btn"
                    class="group inline-flex items-center
                    bg-gradient-to-r from-[#0b0b0b]/20 to-[#0b0b0b]/10
                    backdrop-blur-xl border border-white/20
                    text-[#0b0b0b] shadow-[0_4px_20px_rgba(0,0,0,0.4)]
                    hover:shadow-[0_0_20px_rgba(0,255,200,0.6)]
                    transition-all duration-500 ease-in-out gap-2 mt-4 px-6 py-2">
                    <svg class="w-5 h-5 shrink-0 transition-transform duration-300 group-hover:translate-y-0.5"
                        viewBox="0 0 24 24" fill="none" aria-hidden="true"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5"/>
                        <path d="M7.5 10.5 12 15l4.5-4.5"/>
                        <path d="M12 15V3"/>
                    </svg>
                    <span>Simulation Data</span>
                </button>
            </div>
        </div>
        </div>
        

        <div id="content-impact" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="impact-plots-container">
                <div class="col-span-1 lg:col-span-2 bg-white shadow-lg rounded-xl p-6 text-center text-gray-600">
                    <h3 class="text-lg font-semibold mb-2">Impact Charts</h3>
                    <p>Impact analysis charts will be displayed here.</p>
                </div>
            </div>
        </div>

        <div id="content-priority" class="tab-content hidden">
            <div class="bg-white shadow-lg rounded-xl p-6" id="priority-rankings-container">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Priority Rankings</h3>
                <div class="text-center text-gray-600">
                    <p>Priority ranking analysis will be displayed here.</p>
                </div>
            </div>
        </div>
        <div id="content-scenarios" class="tab-content hidden">
            <div class="bg-white shadow-lg rounded-xl p-6" id="scenarios-container">
                <h3 class="text-lg font-semibold mb-4 text-gray-800"></h3>
                <div class="text-center text-gray-600">
                <p>what if? scenarios will be displayed here.</p>
                </div>
            </div>
        </div>

    {% endif %}
    
</div>

<script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rawData = JSON.parse("{{ df_output_json|escapejs }}");
    const evolutionContainer = document.getElementById("evolution-plots-container");

    // --- Preprocess Data ---
    const firstRow = rawData[0];
    const timeKeys = Object.keys(firstRow)
        .filter(k => /^\d+$/.test(k))
        .sort((a, b) => parseInt(a) - parseInt(b));

    const indicatorData = {};
    rawData.forEach(row => {
        indicatorData[row.indicator_label] = {
            row,
            x: timeKeys.map(k => parseInt(k)),
            y: timeKeys.map(k => row[k]),
            goal: Array(timeKeys.length).fill(row.goal),
        };
    });

    const allIndicators = Object.keys(indicatorData);

    // --- Tab Functionality ---
    window.switchTab = function(tabName) {
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            btn.classList.add('text-gray-600', 'hover:text-gray-800');
            btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        });
        
        // Add active class to clicked tab button
        const activeButton = document.getElementById(`tab-${tabName}`);
        activeButton.classList.add('active');
        activeButton.classList.remove('text-gray-600', 'hover:text-gray-800');
        activeButton.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Show selected tab content
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
    };

    // Initialize active tab styles
    document.getElementById('tab-evolution').classList.add('bg-white', 'text-gray-900', 'shadow-sm');
    document.querySelectorAll('.tab-button:not(#tab-evolution)').forEach(btn => {
        btn.classList.add('text-gray-600', 'hover:text-gray-800');
    });

    // --- Helper Functions ---
    function makePlotWrapper(id, title, color, sdg, container) {
        const plotWrapper = document.createElement('div');
        plotWrapper.className = 'bg-white shadow-lg rounded-xl p-6 h-[400px]';
        
        // Add title and SDG badge
        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-4';
        
        const titleEl = document.createElement('h3');
        titleEl.className = 'text-lg font-semibold text-gray-800 truncate';
        titleEl.textContent = title;
        titleEl.title = title; // Full title on hover
        
        if (sdg) {
            const badge = document.createElement('span');
            badge.className = 'inline-block px-2 py-1 text-xs font-semibold text-white rounded-full';
            badge.style.backgroundColor = color;
            badge.textContent = 'SDG ' + sdg;
            header.appendChild(badge);
        }
        
        header.insertBefore(titleEl, header.firstChild);
        plotWrapper.appendChild(header);
        
        const plotDiv = document.createElement('div');
        plotDiv.id = id;
        plotDiv.style.height = 'calc(100% - 60px)'; // Account for header
        plotWrapper.appendChild(plotDiv);
        container.appendChild(plotWrapper);
        return plotDiv;
    }

    // --- Evolution Charts (Individual Plots) ---
    function renderEvolutionCharts() {
        evolutionContainer.innerHTML = '';

        allIndicators.forEach(label => {
            const dataObj = indicatorData[label];
            const plotDiv = makePlotWrapper(
                `plot-${label.replace(/[^a-zA-Z0-9-_]/g,'')}`, 
                label, 
                dataObj.row.color, 
                dataObj.row.sdg,
                evolutionContainer
            );

            Plotly.newPlot(plotDiv, [
                { 
                    x: dataObj.x, 
                    y: dataObj.y, 
                    mode: 'lines+markers', 
                    name: 'Value', 
                    line: { color: dataObj.row.color, width: 3 },
                    marker: { size: 6 }
                }
            ], {
                xaxis: {
                    title: {  
                        text: 'Time',
                        font: {
                            size: 12,
                            family: 'Roboto, sans-serif',
                            color: '#0b0b0b'
                        },
                        standoff: 10
                    }
                },
                yaxis: {
                    title: { 
                        text: 'Indicator Level',
                        font: {  
                            size: 12,   
                            family: 'Roboto, sans-serif', 
                            color: '#0b0b0b'
                        },
                        standoff: 10
                    }
                },
                legend: { 
                    orientation: 'h', 
                    y: -0.15,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: 10 }
                },
                margin: { l: 60, r: 20, t: 20, b: 60 },
                font: { size: 11 }
            }, { 
                responsive: true,
                displayModeBar: false 
            });
        });
    }

    // --- Excel Download Function ---
    function downloadExcel() {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Create main data worksheet
        const wsData = [];
        
        // Add headers
        const headers = ['Time', ...allIndicators];
        wsData.push(headers);
        
        // Add data rows
        indicatorData[allIndicators[0]].x.forEach((time, idx) => {
            const row = [time];
            allIndicators.forEach(indicator => {
                row.push(indicatorData[indicator].y[idx]);
            });
            wsData.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Simulation Data");
        
        // Create metadata worksheet
        const wsMetaData = [];
        wsMetaData.push(['Indicator', 'SDG', 'Color', 'Goal']);
        
        allIndicators.forEach(indicator => {
            const data = indicatorData[indicator];
            wsMetaData.push([
                indicator,
                data.row.sdg || 'N/A',
                data.row.color || 'N/A',
                data.row.goal || 'N/A'
            ]);
        });
        
        const wsMeta = XLSX.utils.aoa_to_sheet(wsMetaData);
        XLSX.utils.book_append_sheet(wb, wsMeta, "Indicator Metadata");
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `simulation_results_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
        
        // Show success message
        const btn = document.getElementById('download-excel-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Downloaded!
        `;
        btn.classList.add('bg-green-500');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-500');
        }, 2000);
    }

    // --- Initial render ---
    renderEvolutionCharts();

    // Excel Download Event Listener
    document.getElementById('download-excel-btn').addEventListener('click', downloadExcel);
});
</script>

{% endblock %}