{% extends "base.html" %}
{% load static %}
{% block content %}

<style>    
    .gradient-bg {
        background: linear-gradient(135deg, 
            rgba(139, 69, 255, 0.08) 0%, 
            rgba(99, 102, 241, 0.08) 50%, 
            rgba(167, 139, 250, 0.08) 100%);
    }
    
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(139, 69, 255, 0.1);
    }
    
    .calibration-card {
        background: linear-gradient(145deg, 
            rgba(255, 255, 255, 0.95) 0%, 
            rgba(249, 250, 251, 0.95) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 69, 255, 0.15);
        box-shadow: 0 8px 32px rgba(139, 69, 255, 0.1);
    }
    
    .quality-indicator {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .quality-low {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .quality-medium {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .quality-high {
        background: rgba(34, 197, 94, 0.1);
        color: #059669;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, 
            rgba(11, 11, 11, 0.2) 0%, 
            rgba(11, 11, 11, 0.1) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.5s ease-in-out;
    }
    
    .btn-primary:hover {
        box-shadow: 0 0 20px rgba(0, 255, 200, 0.6);
        transform: translateY(-2px);
    }
    
    .btn-disabled {
        background: rgba(156, 163, 175, 0.5);
        color: rgba(156, 163, 175, 0.8);
        cursor: not-allowed;
        border: 1px solid rgba(156, 163, 175, 0.3);
    }
    
    .btn-disabled:hover {
        transform: none;
        box-shadow: none;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(11, 11, 11, 0.3);
        border-radius: 50%;
        border-top-color: #0b0b0b;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .icon-gradient {
        background: linear-gradient(135deg, #8B45FF, #6366F1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stats-grid {
        background: linear-gradient(145deg, 
            rgba(255, 255, 255, 0.8) 0%, 
            rgba(248, 250, 252, 0.8) 100%);
    }
</style>

<div class="bg-[#fffbefff] min-h-screen py-6 sm:py-8 px-4 sm:px-6 lg:px-8 rounded-xl backdrop:blur-xl">
    <div class="mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-r from-[#e2b332ff]/40 to-[#e2b332ff]/40 mb-6">
                <svg class="w-8 h-8 icon-gradient" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <h1 class="text-5xl font-bold bg-[#e2b332ff] bg-clip-text text-transparent mb-4">
                Calibration
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto leading-relaxed">
                Calibrate the model parameters by setting the quality threshold. 
                Higher quality provides better accuracy but requires more processing time.
            </p>
        </div>

        <!-- Main Calibration Form Card -->
        <form id="calibration-form" method="POST" action="{% url 'start_calibration' %}">
            {% csrf_token %}
            <div class="calibration-card rounded-2xl p-8 mb-8">
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-[#cb8700] mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-800">Calibration Quality</h2>
                    </div>
                    <p class="text-gray-600 mb-6">Configure the precision and processing time balance</p>
                </div>

                <!-- Quality Information -->
                <div class="glass-card rounded-xl p-6 mb-8">
                    <h3 class="text-lg font-semibold text-[#0b0b0b] mb-4">Quality Guidelines</h3>
                    <div class="space-y-3 text-gray-600 leading-relaxed">
                        <p>You can determine how good the calibration quality should be. The higher the quality, the more time it takes to calibrate the model. If the calibration is taking too long, you can reset it and choose a lower quality.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div class="text-center p-4 rounded-lg bg-red-50 border border-red-100">
                                <div class="quality-indicator quality-low mb-2">Quick Test</div>
                                <div class="text-sm text-gray-600">0.05 - 0.30</div>
                                <div class="text-xs text-red-600 mt-1">Fast processing</div>
                            </div>
                            <div class="text-center p-4 rounded-lg bg-amber-50 border border-amber-100">
                                <div class="quality-indicator quality-medium mb-2">Balanced</div>
                                <div class="text-sm text-gray-600">0.31 - 0.70</div>
                                <div class="text-xs text-amber-600 mt-1">Moderate time</div>
                            </div>
                            <div class="text-center p-4 rounded-lg bg-green-50 border border-green-100">
                                <div class="quality-indicator quality-high mb-2">High Precision</div>
                                <div class="text-sm text-gray-600">0.71 - 0.99</div>
                                <div class="text-xs text-green-600 mt-1">Longer processing</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Box -->
                <div class="backdrop-blur-2xl rounded-xl p-6 mb-8 bg-amber-50 border border-amber-100">
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2"
                              class="w-7 h-6 mr-3 text-[#cb8700]">
                            <path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20z"/>
                            <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12z"/>
                            <path d="M12 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" fill="currentColor"/>
                        </svg>
                       
                        <div>
                            <h4 class="font-semibold text-[#0b0b0b] mb-2">Recommendation:</h4>
                            <p class="text-gray-500 leading-relaxed">
                                For quick tests, use quality around <strong>0.3</strong>. Once you're confident with your data and exercise type, 
                                calibrate at higher quality. A quality of <strong>1.0</strong> is theoretically perfect but unachievable due to model stochasticity.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Configure Calibration Section -->
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <svg class="w-7 h-8 shrink-0 text-[#cb8700]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                            <!-- outlined triangle -->
                            <path d="M5 5v14l8-7-8-7z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <h3 class="text-xl font-semibold text-[#0b0b0b]">Set Quality Threshold</h3>
                    </div>
                    <p class="text-gray-600 mb-6">Configure the precision level for model calibration</p>
                </div>

                <!-- Input Section -->
                <div class="space-y-6">
                    <div class="glass-card rounded-xl p-8 text-center">
                        <!-- Quality Value Display -->
                        <div class="mb-6">
                            <div id="slider-value" class="text-4xl font-bold text-center text-gray-800 mb-2">0.50</div>
                            <div id="quality-label" class="quality-indicator quality-medium">Balanced</div>
                        </div>
                        
                        <!-- Slider -->
                        <div class="px-4">
                           <input type="range" id="slider" name="threshold" min="0.05" max="0.99" step="0.01" value="0.50"
                         class="w-full h-2 appearance-none rounded-lg outline-none bg-gradient-to-r from-[#8B45FF4D] via-[#6366F14D] to-[#A78BFA4D] [&::-webkit-slider-thumb]:appearance-none
                              [&::-webkit-slider-thumb]:w-6
                              [&::-webkit-slider-thumb]:h-6
                              [&::-webkit-slider-thumb]:rounded-full
                              [&::-webkit-slider-thumb]:cursor-pointer
                              [&::-webkit-slider-thumb]:bg-gradient-to-br
                              [&::-webkit-slider-thumb]:from-[#8B45FF]
                              [&::-webkit-slider-thumb]:to-[#6366F1]
                              [&::-webkit-slider-thumb]:shadow-lg
                              [&::-webkit-slider-thumb]:transition
                              [&::-webkit-slider-thumb]:duration-200
                              [&::-webkit-slider-thumb]:hover:scale-110
                              [&::-webkit-slider-thumb]:hover:shadow-xl
                              [&::-moz-range-thumb]:w-6
                              [&::-moz-range-thumb]:h-6
                              [&::-moz-range-thumb]:rounded-full
                              [&::-moz-range-thumb]:border-0
                              [&::-moz-range-thumb]:cursor-pointer
                              [&::-moz-range-thumb]:bg-gradient-to-br
                              [&::-moz-range-thumb]:from-[#8B45FF]
                              [&::-moz-range-thumb]:to-[#6366F1]
                              [&::-moz-range-thumb]:shadow-lg
                            "/>
                          <div class="flex justify-between text-sm text-gray-500 mt-2">
                            <span>0.05</span>
                            <span class="text-[#0b0b0b] font-medium">Quality Threshold</span>
                            <span>0.99</span>
                          </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="start-calibration-button" type="submit" 
                            class="w-full bg-[#cb8700] text-[#f2f2f2] font-medium py-2 px-6 rounded-[7px] tracking-wide">
                        <div id="btn-content" class="flex items-center justify-center">
                            <svg class="w-7 h-7 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                <!-- outlined triangle -->
                                <path d="M5 5v14l8-7-8-7z" fill="none" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span id="btn-text">START CALIBRATION</span>
                        </div>
                    </button>
                    
                    <!-- Processing State (Hidden by default) -->
                    <div id="processing-state" class="w-full text-[#0b0b0b] font-medium py-2 px-6 rounded-[7px] hidden">
                        <!-- Spinner + Text -->
                        <div class="flex items-center justify-center mb-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-2 border-t-transparent border-[#0b0b0b] mr-3"></div>
                            <span>CALIBRATING...</span>
                        </div>
                    </div>

                    <!-- Tailwind custom animation -->
                    <style>
                    @keyframes shimmer {
                      0% { transform: translateX(-100%); }
                      100% { transform: translateX(100%); }
                    }
                    </style>
                </div>
            </div>
        </form>

        <!-- Disabled button (shown by default) -->
        <div id="next-disabled" class="flex justify-between items-center bg-white p-6 rounded-lg shadow-sm mt-4">
            <p class="text-sm text-gray-500 mt-2">Complete calibration to proceed</p>
            <button disabled class="inline-block px-6 py-2 bg-gray-400 text-white font-semibold rounded cursor-not-allowed">
                <span class="mr-2">NEXT →</span>
            </button>
        </div>

        <!-- Enabled button (hidden initially) -->
        <div id="next-button-container" class="hidden flex justify-between items-center">
            <p class="text-sm text-gray-500">Click the next button to proceed to Simulation</p>
            <a href="{% url 'simulation' %}"
                class="inline-flex items-center gap-2 mt-4 px-4 py-2 font-semibold tracking-wide bg-gradient-to-r from-[#0b0b0b]/20 to-[#0b0b0b]/10 backdrop-blur-xl border border-white/20 text-[#0b0b0b]
                shadow-[0_4px_20px_rgba(0,0,0,0.4)]
                hover:shadow-[0_0_20px_rgba(0,255,200,0.6)]
                transition-all duration-500 ease-in-out">
                <span class="mr-2">NEXT →</span>
            </a>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="stats-grid rounded-xl p-6 text-center border border-gray-200">
                <div class="text-3xl font-bold text-red-500 mb-2">0.05</div>
                <div class="text-gray-600 font-medium">Minimum Quality</div>
            </div>
            <div class="stats-grid rounded-xl p-6 text-center border border-gray-200">
                <div class="text-3xl font-bold text-green-500 mb-2">0.99</div>
                <div class="text-gray-600 font-medium">Maximum Quality</div>
            </div>
            <div class="stats-grid rounded-xl p-6 text-center border border-gray-200">
                <div id="current-quality" class="text-3xl font-bold text-[#cb8700] mb-2">0.50</div>
                <div class="text-gray-600 font-medium">Current Setting</div>
            </div>
        </div>
    </div>
</div>

<script>
const slider = document.getElementById("slider");
const display = document.getElementById("slider-value");
const qualityLabel = document.getElementById("quality-label");
const currentQuality = document.getElementById("current-quality");
const form = document.getElementById("calibration-form");
const startBtn = document.getElementById("start-calibration-button");
const processingState = document.getElementById("processing-state");
const nextButtonContainer = document.getElementById("next-button-container");
const disabledNext = document.getElementById("next-disabled");

let isSubmitting = false;

// Update quality label dynamically
function updateQualityLabel(value) {
    const numValue = parseFloat(value);
    if (numValue <= 0.30) {
        qualityLabel.className = "quality-indicator quality-low";
        qualityLabel.textContent = "Quick Test";
    } else if (numValue <= 0.70) {
        qualityLabel.className = "quality-indicator quality-medium";
        qualityLabel.textContent = "Balanced";
    } else {
        qualityLabel.className = "quality-indicator quality-high";
        qualityLabel.textContent = "High Precision";
    }
}

// Show live slider value
slider.addEventListener("input", function () {
    const value = parseFloat(this.value).toFixed(2);
    display.textContent = value;
    currentQuality.textContent = value;
    updateQualityLabel(this.value);
});

// Initialize on load
updateQualityLabel(slider.value);

// Handle form submission with loading animation and Next button logic
document.addEventListener('DOMContentLoaded', function() {
    const formCard = document.querySelector('.calibration-card');
    
    form.addEventListener("submit", function (e) {
        e.preventDefault();

        if (isSubmitting) return;
        isSubmitting = true;

        // Show processing state immediately
        startBtn.style.display = "none";
        processingState.classList.remove("hidden");
        processingState.classList.add('fade-in');
        
        // Add visual feedback to the card
        formCard.style.opacity = '0.8';

        const formData = new FormData(form);

        fetch("{% url 'start_calibration' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Calibration failed");
            }
            return response.text(); // Django returns HTML
        })
        .then(html => {
            // Calibration finished
            processingState.classList.add("hidden");
            
            // Show Next button
            nextButtonContainer.classList.remove("hidden");
            disabledNext.classList.add("hidden");

            // Optionally: show some results if needed
            const resultsContainer = document.createElement("div");
            resultsContainer.innerHTML = html;
            document.querySelector(".mx-auto").appendChild(resultsContainer);
        })
        .catch(err => {
            alert("Error: " + err.message);
            startBtn.style.display = "block";
            processingState.classList.add("hidden");
            formCard.style.opacity = '1';
            isSubmitting = false;
        });
    });
});
</script>

{% endblock %}